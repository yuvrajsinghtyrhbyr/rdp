name: Ubuntu Tailscale VPS

on:
  workflow_dispatch:
    inputs:
      ts_tailnet:
        description: 'Tailscale tailnet (e.g. you@gmail.com)'
        required: true
        type: string
      ts_api_key:
        description: 'Tailscale API key (device admin)'
        required: true
        type: string
      ts_authkey:
        description: 'Tailscale auth key (reusable/ephemeral)'
        required: true
        type: string
      runtime_minutes:
        description: 'Runtime in minutes (max 360)'
        required: false
        default: '120'
        type: string

jobs:
  ubuntu-vps:
    runs-on: ubuntu-22.04
    timeout-minutes: 370
    
    steps:
    - name: Update system
      run: |
        sudo apt-get update -y
        sudo apt-get install -y curl gnupg lsb-release jq

    - name: Install Tailscale
      run: |
        curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
        curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list
        sudo apt-get update
        sudo apt-get install -y tailscale
        sudo systemctl enable --now tailscaled

    - name: Connect to Tailscale
      run: |
        sudo tailscale up --authkey="${{ github.event.inputs.ts_authkey }}" --hostname="bullet-$(date +%s)" --accept-routes --accept-dns=false
        echo "Tailscale IP: $(sudo tailscale ip -4)"

    - name: Setup SSH access
      run: |
        sudo systemctl enable ssh
        sudo systemctl start ssh
        sudo useradd -m -s /bin/bash devil-devil
        echo 'devil-devil:VPS@123456' | sudo chpasswd
        sudo usermod -aG sudo devil-devil
        
        sudo mkdir -p /home/devil-devil/.ssh
        sudo chmod 700 /home/devil-devil/.ssh
        echo 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCxwyupFObqMZ377b0qim9ayYZv4mTZCtEhfyt2U4bMrEVMHiRHFToPm2FMISI5D2Yv+0uoGgBg1gq7bPHSYajeNtabvi5/lAO9GG9HeokRR3VO/zodB4OeOY7PL5q76ZahEhAvCun9GKQURbgvMPAvsqgIaDG3aBXIdkD1upM3rHerECCd36ayUl15lK0eTD0yURw5SGOmOwB4n4t2FgJHWUtzlhJc+UaUSByAAfy2z4fnRiOBNE8oE/kJVs9agPHobTzEOZtC379rjv8ZxvGKQHiWNBwBazqVLfpk03qStFjiqqOrEMnC/m+zq4/fQFeKGc1fpxWoxJ+1blrQ8ZMr Generated By Termius' | sudo tee /home/devil-devil/.ssh/authorized_keys
        sudo chmod 600 /home/devil-devil/.ssh/authorized_keys
        sudo chown -R devil-devil:devil-devil /home/devil-devil/.ssh
        
        sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config
        sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
        sudo systemctl restart ssh

    - name: Install development tools
      run: |
        sudo apt-get install -y htop neofetch tree git nano vim curl wget unzip screen iptables build-essential lz4 jq make gcc automake autoconf tmux nvme-cli pkg-config libssl-dev libleveldb-dev tar clang bsdmainutils ncdu python3 python3-pip python3-venv python3-dev
        
        curl -fsSL https://deb.nodesource.com/setup_22.x | sudo bash -
        sudo apt install -y nodejs
        sudo npm install -g yarn

    - name: Setup project environment
      run: |
        sudo -u devil-devil bash -c 'cd /home/devil-devil && mkdir -p projects && cd projects && git clone https://github.com/gensyn-ai/rl-swarm/'
        sudo -u devil-devil bash -c 'echo "#!/bin/bash" > /home/devil-devil/setup.sh && echo "cd ~/projects/rl-swarm" >> /home/devil-devil/setup.sh && echo "python3 -m venv .venv" >> /home/devil-devil/setup.sh && echo "source .venv/bin/activate" >> /home/devil-devil/setup.sh && chmod +x /home/devil-devil/setup.sh'

    - name: Show connection info
      run: |
        echo "SSH Connection Details:"
        echo "Host: $(sudo tailscale ip -4)"
        echo "Username: devil-devil"
        echo "Password: VPS@123456"
        echo "SSH Key: Enabled"

    - name: Keep alive
      run: |
        runtime="${{ github.event.inputs.runtime_minutes }}"
        echo "Keeping alive for ${runtime} minutes..."
        sleep $((${runtime} * 60))
